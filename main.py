import sys
sys.path.append(".")

import datetime
import time
import os
from twisted.python import log
from twisted.internet import reactor, protocol
from twisted.internet.protocol import ServerFactory, ClientFactory, Protocol


import MessageClientProtocol as client
import MessageServerProtocol as server
import NeighborManager as neighbor


addresses = ['10.139.40.101','10.139.40.102','10.139.40.103','10.139.40.104' ,'10.139.40.105',
             '10.139.40.106','10.139.40.107','10.139.40.108','10.139.40.109','10.139.40.110',
             '10.139.40.111','10.139.40.112','10.139.40.113','10.139.40.114' ,'10.139.40.115',
             '10.139.40.116','10.139.40.117','10.139.40.118','10.139.40.119','10.139.40.120',
             '10.139.40.121','10.139.40.122','10.139.40.123','10.139.40.124','10.139.40.125',
             '10.139.40.126','10.139.40.127','10.139.40.128','10.139.40.129','10.139.40.130',
             '10.139.40.131','10.139.40.132','10.139.40.133','10.139.40.134','10.139.40.135',
             '10.139.40.136','10.139.40.137','10.139.40.138','10.139.40.139','10.139.40.140',
             '10.139.40.141','10.139.40.142','10.139.40.143','10.139.40.144','10.139.40.145',
             '10.139.40.146','10.139.40.147','10.139.40.148','10.139.40.149','10.139.40.150'
            ]

gwAddresses = ['10.145.32.66', '10.138.57.2', '10.138.85.130', 
               '10.139.37.194', '10.138.25.67', '10.228.192.210', '10.228.193.210',
              '10.228.204.9', '10.138.129.98','10.140.150.227']

#addresses = ['10.0.0.1','10.0.0.2','10.0.0.3', '10.0.0.4','10.0.0.5'
#             ,'10.0.0.6','10.0.0.7','10.0.0.8','10.0.0.9','10.0.0.10'
#            ,'10.0.0.11','10.0.0.12','10.0.0.13', '10.0.0.14','10.0.0.15'
#             ,'10.0.0.16','10.0.0.17','10.0.0.18','10.0.0.19','10.0.0.20'
#            ,'10.0.0.21','10.0.0.22','10.0.0.23', '10.0.0.24','10.0.0.25'
#             ,'10.0.0.26','10.0.0.27','10.0.0.28','10.0.0.29','10.0.0.30'
#            ,'10.0.0.31','10.0.0.32','10.0.0.33', '10.0.0.34','10.0.0.35'
#             ,'10.0.0.36','10.0.0.37','10.0.0.38','10.0.0.39','10.0.0.40'
#            ,'10.0.0.41','10.0.0.42','10.0.0.43', '10.0.0.44','10.0.0.45'
#             ,'10.0.0.46','10.0.0.47','10.0.0.48','10.0.0.49','10.0.0.50']

#gwAddresses = ['10.0.1.1', '10.0.1.2', '10.0.1.3', '10.0.1.4', '10.0.1.5',
#               '10.0.1.6', '10.0.1.7', '10.0.1.8', '10.0.1.9', '10.0.1.10']

nm = neighbor.NeighborManager()

nm.myAddress = str(sys.argv[1])
nm.neighbors = addresses
nm.gateways = gwAddresses
nm.trshld = 10
nm.period = 120
nm.sampleSize = 3


if reactor.running:
    reactor.stop()
    
factory = protocol.ServerFactory()
factory.protocol = server.MessageServerProtocol
factory.protocol.client = nm
reactor.listenTCP(5555, factory)


reactor.callLater(5,nm.senseNeighbors)
reactor.callLater(15, nm.send)
#reactor.callLater(15, nm.senseBest)
reactor.callLater(nm.period, nm.download)

reactor.run()
